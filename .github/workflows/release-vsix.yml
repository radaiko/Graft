name: Release VS Extension

on:
  push:
    tags:
      - "vs/v*"

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#vs/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          git fetch --tags
          PREV_TAG=$(git tag --list 'vs/v*' --sort=-v:refname | grep -v "^$TAG$" | head -1)
          echo "prev_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"

      - name: Generate filtered release notes
        id: notes
        uses: ./.github/actions/product-release-notes
        with:
          product-label: "product:vs"
          tag: ${{ steps.version.outputs.tag }}
          previous-tag: ${{ steps.version.outputs.prev_tag }}

      - name: Create draft release
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_NOTES: ${{ steps.notes.outputs.notes }}
        run: |
          printf '%s' "$RELEASE_NOTES" > /tmp/release-notes.md
          gh release create "vs/v${{ steps.version.outputs.version }}" \
            --title "VS Extension v${{ steps.version.outputs.version }}" \
            --draft \
            --latest=false \
            --notes-file /tmp/release-notes.md

  build:
    needs: create-release
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      HAS_MARKETPLACE_PAT: ${{ secrets.VS_MARKETPLACE_PAT != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore src/Graft.sln

      - name: Update VSIX version
        shell: pwsh
        run: |
          $manifest = "src/Graft.VS2026Extension/source.extension.vsixmanifest"
          [xml]$xml = Get-Content $manifest
          $ns = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)
          $ns.AddNamespace("vs", "http://schemas.microsoft.com/developer/vsx-schema/2011")
          $identity = $xml.SelectSingleNode("//vs:Identity", $ns)
          $identity.SetAttribute("Version", "${{ needs.create-release.outputs.version }}")
          $xml.Save((Resolve-Path $manifest))

      - name: Build VSIX
        run: >
          msbuild src/Graft.VS2026Extension/Graft.VS2026Extension.csproj
          /p:Configuration=Release
          /p:DeployExtension=false

      - name: Find VSIX
        id: vsix
        shell: pwsh
        run: |
          $vsix = Get-ChildItem -Path src/Graft.VS2026Extension -Recurse -Filter *.vsix | Select-Object -First 1
          if (-not $vsix) { Write-Error "No .vsix file found"; exit 1 }
          Write-Host "Found VSIX at: $($vsix.FullName)"
          echo "path=$($vsix.FullName)" >> $env:GITHUB_OUTPUT

      - name: Upload VSIX to release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "vs/v${{ needs.create-release.outputs.version }}" \
            "${{ steps.vsix.outputs.path }}"

      - name: Publish to VS Marketplace
        if: env.HAS_MARKETPLACE_PAT == 'true'
        uses: cezarypiatek/VsixPublisherAction@1.1
        with:
          extension-file: ${{ steps.vsix.outputs.path }}
          publish-manifest-file: src/Graft.VS2026Extension/publishManifest.json
          personal-access-code: ${{ secrets.VS_MARKETPLACE_PAT }}

  publish-release:
    needs: [create-release, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release edit "vs/v${{ needs.create-release.outputs.version }}" \
            --draft=false
